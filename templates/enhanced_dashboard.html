<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Sale Tracker Dashboard</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .metric-card { @apply bg-white rounded-lg shadow-md p-4 border-l-4; }
        .metric-value { @apply text-2xl font-bold; }
        .metric-label { @apply text-sm text-gray-600; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="enhancedDashboard()" x-init="loadData()" class="container mx-auto px-4 py-8">
        
        <!-- Enhanced Header with System Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        üõçÔ∏è Enhanced Sale Tracker
                        <span class="ml-3 px-2 py-1 text-xs rounded-full"
                              :class="systemStatus === 'healthy' ? 'bg-green-100 text-green-800' : 
                                     systemStatus === 'degraded' ? 'bg-yellow-100 text-yellow-800' : 
                                     'bg-red-100 text-red-800'"
                              x-text="systemStatus || 'loading'"></span>
                    </h1>
                    <p class="text-gray-600 mt-2">Advanced price monitoring with new retailer framework</p>
                    <div class="mt-2 text-sm text-gray-500">
                        <span>Version: {{ system_info.config_version }}</span> | 
                        <span x-text="supportedRetailers.length"></span> Retailers | 
                        <span x-show="cacheStats.enabled">Cache Enabled</span>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Scheduler</div>
                        {% if scheduler_text %}
                        <div class="font-semibold text-blue-700">{{ scheduler_text }}</div>
                        {% else %}
                        <div :class="isRunning ? 'text-green-600' : 'text-red-600'" class="font-semibold">
                            <span x-text="isRunning ? 'Running' : 'Stopped'"></span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="text-right" x-show="lastEmail">
                        <div class="text-sm text-gray-500">Last Email</div>
                        <div class="font-semibold text-gray-800" x-text="formatDate(lastEmail)"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="metric-card border-blue-500">
                <div class="metric-value text-blue-600" x-text="performanceMetrics.total_products || '0'"></div>
                <div class="metric-label">Total Products</div>
            </div>
            <div class="metric-card border-green-500">
                <div class="metric-value text-green-600" x-text="performanceMetrics.successful_scrapes || '0'"></div>
                <div class="metric-label">Successful Scrapes</div>
            </div>
            <div class="metric-card border-red-500">
                <div class="metric-value text-red-600" x-text="performanceMetrics.failed_scrapes || '0'"></div>
                <div class="metric-label">Failed Scrapes</div>
            </div>
            <div class="metric-card border-purple-500">
                <div class="metric-value text-purple-600">
                    <span x-text="Math.round(performanceMetrics.success_rate || 0)"></span>%
                </div>
                <div class="metric-label">Success Rate</div>
            </div>
        </div>

        <!-- Enhanced Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-3">
                    <button @click="refreshData()" 
                            :disabled="loading"
                            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded flex items-center">
                        <span class="mr-2" x-show="!loading">üîÑ</span>
                        <span class="mr-2 animate-spin" x-show="loading">‚è≥</span>
                        <span x-text="loading ? 'Refreshing...' : 'Refresh Data'"></span>
                    </button>
                    
                    <button @click="clearCache()" 
                            class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded"
                            x-show="cacheStats.enabled && cacheStats.size > 0">
                        üóëÔ∏è Clear Cache (<span x-text="cacheStats.size"></span>)
                    </button>
                    
                    <button @click="showHealthModal = true" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        üè• System Health
                    </button>
                </div>
                
                <div class="text-sm text-gray-500" x-show="lastRefresh">
                    Last updated: <span x-text="formatDate(lastRefresh)"></span>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div x-show="message" x-transition class="fixed top-4 right-4 z-50">
            <div :class="messageType === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'" 
                 class="shadow-lg rounded-md px-6 py-4 min-w-80">
                <p class="text-sm font-medium" x-text="message"></p>
            </div>
        </div>

        <!-- User Management Section -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Email Management -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìß Email Notifications</h2>
                <form @submit.prevent="addRecipient" class="mb-4">
                    <div class="flex gap-3">
                        <input x-model="recipientEmail" type="email" required 
                               placeholder="you@example.com" 
                               class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-300" />
                        <button type="submit" 
                                :disabled="!recipientEmail" 
                                class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white px-4 py-2 rounded">
                            Save Email
                        </button>
                    </div>
                </form>
                <div class="text-sm text-gray-600">
                    <p>‚ú® Emails sent daily at 21:00 UTC</p>
                    <p class="mt-1">üìä Enhanced format with performance metrics</p>
                </div>
            </div>

            <!-- Product Subscription -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üîó Add Product</h2>
                <form @submit.prevent="addSubscription" class="space-y-3">
                    <input x-model="subEmail" type="email" required 
                           placeholder="you@example.com" 
                           class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-300" />
                    <div class="relative">
                        <input x-model="subUrl" type="url" required 
                               placeholder="Product URL (Lululemon or Nike)" 
                               class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-300" />
                        <button type="button" @click="testRetailerUrl()" 
                                class="absolute right-2 top-2 text-blue-600 hover:text-blue-800">
                            üß™
                        </button>
                    </div>
                    <button type="submit" 
                            :disabled="!subEmail || !subUrl" 
                            class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white px-4 py-2 rounded">
                        Add Product
                    </button>
                </form>
                <div class="mt-3 text-xs text-gray-500">
                    <p><strong>Supported retailers:</strong> <span x-text="supportedRetailers.join(', ')"></span></p>
                </div>
            </div>
        </div>

        <!-- Subscription Management -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìã Your Subscriptions</h2>
            <div class="flex gap-3 mb-4">
                <input x-model="subListEmail" type="email" 
                       placeholder="Enter email to view subscriptions" 
                       class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-300" />
                <button @click="loadSubscriptions()" 
                        class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">
                    Load Subscriptions
                </button>
            </div>
            <div class="space-y-2" x-show="subscriptions.length > 0">
                <template x-for="item in subscriptions" :key="item.url">
                    <div class="flex items-center justify-between border rounded px-4 py-3 hover:bg-gray-50">
                        <div class="flex-1">
                            <a :href="item.url" target="_blank" 
                               class="text-blue-600 hover:text-blue-800 break-all text-sm"
                               x-text="item.url"></a>
                            <div class="text-xs text-gray-500 mt-1" x-show="item.company">
                                Retailer: <span x-text="item.company" class="capitalize"></span>
                            </div>
                        </div>
                        <button @click="removeSubscription(item.url)" 
                                class="ml-3 text-red-600 hover:text-red-800 text-sm">
                            Remove
                        </button>
                    </div>
                </template>
            </div>
            <div x-show="subscriptions.length === 0 && subListEmail" 
                 class="text-gray-500 text-center py-4">
                No subscriptions found for this email.
            </div>
        </div>

        <!-- Enhanced Products Grid -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-800">
                    üõí Tracked Products
                    <span x-show="products.length > 0" 
                          class="text-sm font-normal text-gray-500">
                        (<span x-text="products.filter(p => p.success).length"></span>/<span x-text="products.length"></span> successful)
                    </span>
                </h2>
                
                <!-- Retailer Filter -->
                <div class="flex items-center gap-3">
                    <label class="text-sm text-gray-600">Filter:</label>
                    <select x-model="retailerFilter" class="border rounded px-3 py-1 text-sm">
                        <option value="">All Retailers</option>
                        <template x-for="retailer in supportedRetailers" :key="retailer">
                            <option :value="retailer" x-text="retailer.charAt(0).toUpperCase() + retailer.slice(1)"></option>
                        </template>
                    </select>
                </div>
            </div>

            <div x-show="filteredProducts.length === 0" class="text-center py-12 text-gray-500">
                <div class="text-4xl mb-4">üîç</div>
                <p class="text-lg">No products to display</p>
                <p class="text-sm">Click "Refresh Data" to scrape products</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" x-show="filteredProducts.length > 0">
                <template x-for="product in filteredProducts" :key="product.url">
                    <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow"
                         :class="product.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'">
                        
                        <!-- Retailer Badge -->
                        <div class="flex justify-between items-start mb-3">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full"
                                  :class="getRetailerBadgeClass(product.retailer)"
                                  x-text="product.retailer.toUpperCase()"></span>
                            <span class="text-xs" 
                                  :class="product.success ? 'text-green-600' : 'text-red-600'"
                                  x-text="product.success ? '‚úÖ' : '‚ùå'"></span>
                        </div>

                        <!-- Product Image -->
                        <div x-show="product.image" class="mb-3">
                            <img :src="product.image" 
                                 :alt="product.name" 
                                 class="w-full h-32 object-cover rounded"
                                 @error="$event.target.style.display='none'">
                        </div>

                        <!-- Product Info -->
                        <div class="space-y-2">
                            <h3 class="font-semibold text-gray-800 text-sm leading-tight" 
                                x-text="product.name"></h3>
                            
                            <div class="text-lg font-bold"
                                 :class="product.success ? 'text-green-700' : 'text-red-600'"
                                 x-text="product.price"></div>
                            
                            <div class="text-xs text-gray-500">
                                Updated: <span x-text="formatDate(product.timestamp)"></span>
                            </div>
                            
                            <a :href="product.url" target="_blank" 
                               class="inline-block text-blue-600 hover:text-blue-800 text-sm">
                                View Product ‚Üí
                            </a>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- System Health Modal -->
        <div x-show="showHealthModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">üè• System Health Status</h3>
                    <button @click="showHealthModal = false" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 border rounded">
                        <span>Overall Status</span>
                        <span class="px-2 py-1 text-xs rounded-full"
                              :class="systemStatus === 'healthy' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                              x-text="systemStatus"></span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 border rounded">
                            <div class="text-sm text-gray-600">Retailers Available</div>
                            <div class="font-semibold" x-text="supportedRetailers.length"></div>
                        </div>
                        <div class="p-3 border rounded">
                            <div class="text-sm text-gray-600">Cache Status</div>
                            <div class="font-semibold" x-text="cacheStats.enabled ? 'Enabled' : 'Disabled'"></div>
                        </div>
                        <div class="p-3 border rounded">
                            <div class="text-sm text-gray-600">Cache Size</div>
                            <div class="font-semibold" x-text="cacheStats.size + ' items'"></div>
                        </div>
                        <div class="p-3 border rounded">
                            <div class="text-sm text-gray-600">Last Scrape</div>
                            <div class="font-semibold text-xs" x-text="formatDate(performanceMetrics.last_scrape_time)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function enhancedDashboard() {
            return {
                // State
                products: [],
                isRunning: false,
                lastEmail: null,
                lastRefresh: null,
                loading: false,
                message: '',
                messageType: 'info',
                
                // Enhanced state
                systemStatus: 'loading',
                performanceMetrics: {},
                supportedRetailers: [],
                cacheStats: { enabled: false, size: 0 },
                retailerFilter: '',
                
                // Form data
                recipientEmail: '',
                subEmail: '',
                subUrl: '',
                subListEmail: '',
                subscriptions: [],
                
                // UI state
                showHealthModal: false,

                // Computed properties
                get filteredProducts() {
                    if (!this.retailerFilter) return this.products;
                    return this.products.filter(p => p.retailer === this.retailerFilter);
                },

                // Initialization
                async loadData() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/enhanced/scrape');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.products = data.results || [];
                            this.performanceMetrics = data.performance_metrics || {};
                            this.supportedRetailers = data.summary?.retailers || [];
                            this.cacheStats = data.cache_stats || { enabled: false, size: 0 };
                            this.systemStatus = 'healthy';
                            this.lastRefresh = new Date().toISOString();
                        } else {
                            throw new Error(data.error || 'Failed to load data');
                        }
                    } catch (error) {
                        this.showMessage('Failed to load data: ' + error.message, 'error');
                        this.systemStatus = 'error';
                    } finally {
                        this.loading = false;
                    }
                },

                async refreshData() {
                    await this.loadData();
                    this.showMessage('Data refreshed successfully!', 'success');
                },

                async clearCache() {
                    try {
                        const response = await fetch('/api/enhanced/cache', { method: 'DELETE' });
                        const data = await response.json();
                        
                        if (data.success) {
                            this.cacheStats = data.cache_stats;
                            this.showMessage('Cache cleared successfully!', 'success');
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        this.showMessage('Failed to clear cache: ' + error.message, 'error');
                    }
                },

                async testRetailerUrl() {
                    if (!this.subUrl) {
                        this.showMessage('Please enter a URL first', 'error');
                        return;
                    }

                    try {
                        const response = await fetch('/api/enhanced/test-retailer', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: this.subUrl })
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            this.showMessage(`‚úÖ ${data.retailer.toUpperCase()}: ${data.name} - ${data.price}`, 'success');
                        } else {
                            this.showMessage(`‚ùå ${data.error}`, 'error');
                        }
                    } catch (error) {
                        this.showMessage('Test failed: ' + error.message, 'error');
                    }
                },

                // Recipients management
                async addRecipient() {
                    try {
                        const response = await fetch('/api/recipients', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.recipientEmail })
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            this.showMessage('Email added successfully!', 'success');
                            this.recipientEmail = '';
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        this.showMessage('Failed to add email: ' + error.message, 'error');
                    }
                },

                // Subscriptions management
                async addSubscription() {
                    try {
                        const response = await fetch('/api/subscriptions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                email: this.subEmail, 
                                url: this.subUrl 
                            })
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            this.showMessage('Product subscription added!', 'success');
                            this.subEmail = '';
                            this.subUrl = '';
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        this.showMessage('Failed to add subscription: ' + error.message, 'error');
                    }
                },

                async loadSubscriptions() {
                    if (!this.subListEmail) return;
                    
                    try {
                        const response = await fetch(`/api/subscriptions?email=${encodeURIComponent(this.subListEmail)}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            this.subscriptions = data.products || [];
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        this.showMessage('Failed to load subscriptions: ' + error.message, 'error');
                    }
                },

                async removeSubscription(url) {
                    try {
                        const response = await fetch('/api/subscriptions', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                email: this.subListEmail, 
                                url: url 
                            })
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            await this.loadSubscriptions();
                            this.showMessage('Subscription removed!', 'success');
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        this.showMessage('Failed to remove subscription: ' + error.message, 'error');
                    }
                },

                // Utility functions
                formatDate(dateString) {
                    if (!dateString) return 'Never';
                    try {
                        return new Date(dateString).toLocaleString();
                    } catch {
                        return 'Invalid date';
                    }
                },

                getRetailerBadgeClass(retailer) {
                    const classes = {
                        'lululemon': 'bg-red-100 text-red-800',
                        'nike': 'bg-orange-100 text-orange-800',
                        'default': 'bg-gray-100 text-gray-800'
                    };
                    return classes[retailer] || classes.default;
                },

                showMessage(text, type = 'info') {
                    this.message = text;
                    this.messageType = type;
                    setTimeout(() => {
                        this.message = '';
                    }, 5000);
                }
            }
        }
    </script>
</body>
</html>