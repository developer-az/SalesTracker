<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div x-data="dashboard()" x-init="loadData()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Sale Tracker Dashboard</h1>
                    <p class="text-gray-600 mt-2">Monitor product prices from Lululemon and Nike</p>
                </div>
                <div class="flex space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Status</div>
                        {% if scheduler_text %}
                        <div class="font-semibold text-blue-700">{{ scheduler_text }}</div>
                        {% else %}
                        <div :class="isRunning ? 'text-green-600' : 'text-red-600'" class="font-semibold">
                            <span x-text="isRunning ? 'Running' : 'Stopped'"></span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="text-right" x-show="lastEmail">
                        <div class="text-sm text-gray-500">Last Email</div>
                        <div class="font-semibold text-gray-800" x-text="formatDate(lastEmail)"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Minimal Message -->
        <div class="bg-blue-50 border border-blue-200 text-blue-800 rounded p-4 mb-6">
            Add your email and product URLs below. You’ll receive a daily email at 9 PM.
        </div>

        <!-- Status Messages -->
        <div x-show="message" x-transition class="mb-6">
            <div :class="messageType === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700'" 
                 class="border-l-4 p-4 rounded">
                <p x-text="message"></p>
            </div>
        </div>

        <!-- Remove configuration block for minimal UI -->

        <!-- Minimal: Email + Product URL -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Get Notified</h2>
            <form @submit.prevent="addRecipient" class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Your Email</label>
                <div class="flex gap-3">
                    <input x-model="recipientEmail" type="email" required placeholder="you@example.com" class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-300" />
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save Email</button>
                </div>
                <p class="text-xs text-gray-500 mt-2">We’ll send a daily email at 9 PM.</p>
            </form>
            <form @submit.prevent="addSubscription">
                <label class="block text-sm font-medium text-gray-700 mb-2">Product URL</label>
                <div class="space-y-3">
                    <input x-model="subEmail" type="email" required placeholder="you@example.com" class="w-full border rounded px-3 py-2" />
                    <input x-model="subUrl" type="url" required placeholder="https://shop.lululemon.com/... or https://www.nike.com/t/..." class="w-full border rounded px-3 py-2" />
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add Product</button>
                </div>
            </form>
        </div>

        <!-- Minimal Subscriptions List -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Your Subscriptions</h2>
            <div class="flex gap-3 mb-3">
                <input x-model="subListEmail" type="email" placeholder="you@example.com" class="flex-1 border rounded px-3 py-2" />
                <button @click="loadSubscriptions()" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">Load</button>
            </div>
            <div class="space-y-2" x-show="subscriptions.length > 0">
                <template x-for="item in subscriptions" :key="item.url">
                    <div class="flex items-center justify-between border rounded px-3 py-2">
                        <a :href="item.url" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 truncate" x-text="item.url"></a>
                        <button @click="removeSubscription(item.url)" class="text-sm text-red-600 hover:text-red-800">Remove</button>
                    </div>
                </template>
            </div>
            <div x-show="subscriptions.length === 0" class="text-gray-500 text-sm">No subscriptions loaded.</div>
        </div>

        <!-- Products Grid -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                Tracked Products 
                <span x-show="products.length > 0" class="text-sm font-normal text-gray-500">
                    (Last updated: <span x-text="formatDate(lastUpdate)"></span>)
                </span>
            </h2>
            
            <div x-show="products.length === 0" class="text-center py-12 text-gray-500">
                <div class="text-4xl mb-4">📦</div>
                <p>No products scraped yet. Click "Scrape Products" to start!</p>
            </div>

            <div x-show="products.length > 0" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <template x-for="product in products" :key="product.link">
                    <div class="border rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
                        <!-- Product Image -->
                        <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                            <img x-show="product.image" 
                                 :src="product.image" 
                                 :alt="product.name"
                                 class="w-full h-48 object-cover"
                                 @error="$event.target.style.display = 'none'">
                            <div x-show="!product.image" class="w-full h-48 bg-gray-200 flex items-center justify-center">
                                <span class="text-gray-400 text-4xl">📦</span>
                            </div>
                        </div>
                        
                        <!-- Product Info -->
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span :class="product.company === 'lululemon' ? 'bg-red-100 text-red-800' : 'bg-black text-white'" 
                                      class="px-2 py-1 rounded text-xs font-medium uppercase" 
                                      x-text="product.company"></span>
                                <span :class="product.success ? 'text-green-600' : 'text-red-600'" 
                                      class="text-xs">
                                    <span x-text="product.success ? '✅' : '❌'"></span>
                                </span>
                            </div>
                            
                            <h3 class="font-semibold text-gray-800 mb-2 line-clamp-2" x-text="product.name"></h3>
                            
                            <div class="flex items-center justify-between">
                                <span class="text-lg font-bold" 
                                      :class="product.success ? 'text-green-600' : 'text-red-600'" 
                                      x-text="product.price"></span>
                                <a :href="product.link" 
                                   target="_blank" 
                                   class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    View →
                                </a>
                            </div>
                            
                            <div class="mt-2 text-xs text-gray-500" x-text="formatDate(product.timestamp)"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                products: [],
                isRunning: false,
                lastEmail: null,
                lastUpdate: null,
                loading: false,
                message: '',
                messageType: 'success',
                recipients: [],
                recipientEmail: '',
                // Subscriptions state
                subEmail: '',
                subUrl: '',
                subListEmail: '',
                subscriptions: [],

                async loadData() {
                    try {
                        const response = await fetch('/api/scrape');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.products = data.products;
                            this.lastUpdate = data.timestamp;
                        }
                        
                        // Load status
                        const statusResponse = await fetch('/api/status');
                        const statusData = await statusResponse.json();
                        this.isRunning = statusData.is_running;
                        this.lastEmail = statusData.last_email_sent;
                        // Load recipients
                        const recRes = await fetch('/api/recipients');
                        const recData = await recRes.json();
                        if (recData.success) this.recipients = recData.recipients;
                        // Load subscriptions if an email is set
                        if (this.subListEmail) {
                            await this.loadSubscriptions();
                        }
                        
                    } catch (error) {
                        this.showMessage('Failed to load data: ' + error.message, 'error');
                    }
                },

                // Remove manual scrape to keep UI minimal

                async addSubscription() {
                    try {
                        const response = await fetch('/api/subscriptions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.subEmail, url: this.subUrl })
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.showMessage('Product added to your subscriptions', 'success');
                            this.subUrl = '';
                            if (this.subListEmail === this.subEmail) this.loadSubscriptions();
                        } else {
                            this.showMessage(data.error || 'Failed to add product', 'error');
                        }
                    } catch (e) {
                        this.showMessage('Error adding product: ' + e.message, 'error');
                    }
                },

                async loadSubscriptions() {
                    try {
                        const response = await fetch('/api/subscriptions?email=' + encodeURIComponent(this.subListEmail));
                        const data = await response.json();
                        if (data.success) {
                            this.subscriptions = data.products || [];
                        } else {
                            this.showMessage(data.error || 'Failed to load subscriptions', 'error');
                        }
                    } catch (e) {
                        this.showMessage('Error loading subscriptions: ' + e.message, 'error');
                    }
                },

                async removeSubscription(url) {
                    try {
                        const response = await fetch('/api/subscriptions', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.subListEmail, url })
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.showMessage('Subscription removed', 'success');
                            this.subscriptions = this.subscriptions.filter(i => i.url !== url);
                        } else {
                            this.showMessage(data.error || 'Failed to remove subscription', 'error');
                        }
                    } catch (e) {
                        this.showMessage('Error removing subscription: ' + e.message, 'error');
                    }
                },

                async addRecipient() {
                    try {
                        const response = await fetch('/api/recipients', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.recipientEmail })
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.showMessage('Added recipient successfully', 'success');
                            this.recipientEmail = '';
                            const recRes = await fetch('/api/recipients');
                            const recData = await recRes.json();
                            if (recData.success) this.recipients = recData.recipients;
                        } else {
                            this.showMessage(data.error || 'Failed to add recipient', 'error');
                        }
                    } catch (e) {
                        this.showMessage('Error adding recipient: ' + e.message, 'error');
                    }
                },

                async removeRecipient(email) {
                    try {
                        const response = await fetch('/api/recipients', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email })
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.showMessage('Recipient removed', 'success');
                            this.recipients = this.recipients.filter(e => e !== email);
                        } else {
                            this.showMessage(data.error || 'Failed to remove recipient', 'error');
                        }
                    } catch (e) {
                        this.showMessage('Error removing recipient: ' + e.message, 'error');
                    }
                },

                // Remove manual send to keep UI minimal

                // Remove scheduler toggles in minimal UI

                showMessage(text, type = 'success') {
                    this.message = text;
                    this.messageType = type;
                    setTimeout(() => {
                        this.message = '';
                    }, 5000);
                },

                formatDate(dateString) {
                    if (!dateString) return 'Never';
                    return new Date(dateString).toLocaleString();
                }
            }
        }
    </script>
</body>
</html>
